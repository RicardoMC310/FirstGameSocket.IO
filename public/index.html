<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Firsts Game</title>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        canvas {
            width: 90dvw;
            height: 90dvw;
            max-width: 350px;
            max-height: 350px;
            background-color: #ebebeb;
            border: 1px solid black;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>

</head>

<body>

    <canvas width="640" height="640"></canvas>
    <div id="comecar">
        <input type="number" id="delaySpawnFruits" required placeholder="delay spawn fruits in ms" min="0" max="10000"
            step="1" value="1000">
        <button>começar</button>
    </div>

    <script type="module">
        import createGameState from "./globals/game.js";
        import createKeyboardListener from "./globals/keyboard.js";

        const canvas = document.querySelector("canvas");
        const ctx = canvas.getContext("2d");

        const divAdmin = document.querySelector("#comecar");
        const inputDelay = document.querySelector("#comecar input");
        const buttonComecar = document.querySelector("#comecar button");

        const socket = io();

        let playerId = undefined;
        let game = createGameState();
        let playerAdmin = {};
        let keyboardListener = undefined;

        game.subscripe((command) => {
            socket.emit("playerMoved", command);
        });

        socket.on("connect", () => {
            playerId = socket.id;
        });

        socket.on("otherPlayerMoved", (player) => {
            if (game.state.players[player.playerId]) {
                game.state.players[player.playerId].x = player.x;
                game.state.players[player.playerId].y = player.y;
            }
        });

        socket.on("setup", (gameState) => {
            game.setState(gameState.state);
            keyboardListener = createKeyboardListener(playerId, document);
            keyboardListener.subscripe(game.playerMoved);
        });
        
        socket.on("playerAdmin", (serverPlayerAdmin) => {
            playerAdmin = serverPlayerAdmin;
            divAdmin.style.display = "none";

            if (playerAdmin.playerId === playerId) {
                divAdmin.style.display = "block";
                buttonComecar.addEventListener("click", () => {
                    console.log("> começar!");
                    socket.emit("initGame", inputDelay.value);
                });
            }
        });

        socket.on("updateFruits", (fruits) => {
            game.state.fruits = fruits;
        })

        socket.on("playerJoined", (player) => {
            if (player) {
                let p = { x: player.x, y: player.y };
                game.state.players[player.playerId] = p;
            }
        });

        socket.on("playerDisconnected", (playerId) => {
            delete game.state.players[playerId];
        });

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (const player in game.state.players) {
                ctx.fillStyle = "rgba(30, 30, 30, 0.25)";
                ctx.fillRect(game.state.players[player].x, game.state.players[player].y, 32, 32);
                if (player == playerId) {
                    continue;
                }
            }

            for (const fruit in game.state.fruits) {
                ctx.fillStyle = "rgb(200, 70, 45)";
                ctx.fillRect(
                    game.state.fruits[fruit].x,
                    game.state.fruits[fruit].y,
                    32, 32
                )
            }

            if (playerId) {
                let p = game.state.players[playerId];
                ctx.fillStyle = "rgb(40, 200, 40)";
                ctx.fillRect(p.x, p.y, 32, 32);
            }

            requestAnimationFrame(draw);
        }

        draw();
    </script>

</body>

</html>