<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Firsts Game</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="./style.css">

</head>

<body>

    <div class="app">
        <div class="game-card">
            <div class="topbar">
                <div>
                    <div class="title">My Firsts Game</div>
                    <div class="meta">Jogue com amigos — pegue frutas e pontue</div>
                </div>
                <div class="meta">Controles: setas / WASD</div>
            </div>

            <canvas width="640" height="640"></canvas>
        </div>

        <aside class="sidebar">
            <div id="comecar">
                <input type="number" id="delaySpawnFruits" required placeholder="delay spawn fruits in ms" min="0" max="10000" step="1" value="1000">
                <button>começar</button>
            </div>

            <div style="font-size:0.95rem;color:var(--muted);">Ranking</div>
            <ul id="scores"></ul>

            <div style="margin-top:auto;font-size:0.80rem;color:rgba(255,255,255,0.42);">
                servidor local • desenvolvido com ❤️
            </div>
        </aside>
    </div>

    <script type="module">
        import createGameState from "./globals/game.js";
        import createKeyboardListener from "./globals/keyboard.js";

        const canvas = document.querySelector("canvas");
        const ctx = canvas.getContext("2d");

        const divAdmin = document.querySelector("#comecar");
        const inputDelay = document.querySelector("#comecar input");
        const buttonComecar = document.querySelector("#comecar button");

        const socket = io();

        let playerId = undefined;
        let game = createGameState();
        let playerAdmin = {};
        let keyboardListener = undefined;

        function updateScore() {
            const ranking = Object.entries(game.state.players)
                .sort(([, a], [, b]) => b.score - a.score)
                .map(([id, data], index) => ({
                    rank: index + 1,
                    id,
                    score: data.score
                })).slice(0, 5);

            const ul = document.querySelector("ul");
            ul.innerHTML = "";

            for (const player of ranking) {
                const li = document.createElement("li");
                li.textContent = `#${player.rank} ${player.id} — ${player.score} pontos`;
                if (player.id == playerId) {
                    li.classList.add("li-my");
                }
                if (player.rank == 1) {
                    li.classList.add("li-primary");
                }
                ul.appendChild(li);
            }
        }

        game.subscripe((command) => {
            socket.emit("playerMoved", command);
        });

        socket.on("connect", () => {
            playerId = socket.id;
        });

        socket.on("otherPlayerMoved", (player) => {
            if (game.state.players[player.playerId]) {
                game.state.players[player.playerId].x = player.x;
                game.state.players[player.playerId].y = player.y;
            }
        });

        socket.on("setup", (gameState) => {
            game.setState(gameState.state);
            keyboardListener = createKeyboardListener(playerId, document);
            keyboardListener.subscripe(game.playerMoved);
            updateScore();
        });

        socket.on("playerAdmin", (serverPlayerAdmin) => {
            playerAdmin = serverPlayerAdmin;
            divAdmin.style.display = "none";

            if (playerAdmin.playerId === playerId) {
                divAdmin.style.display = "block";
                buttonComecar.addEventListener("click", () => {
                    console.log("> começar!");
                    socket.emit("initGame", inputDelay.value);
                });
            }
        });

        socket.on("updateScore", (playerId, score) => {
            if (game.state.players[playerId]) {
                game.state.players[playerId].score = score;
                updateScore();
            }
        });

        socket.on("updateFruits", (fruits) => {
            game.state.fruits = fruits;
        })

        socket.on("playerJoined", (player) => {
            if (player) {
                let p = { x: player.x, y: player.y, score: player.score };
                game.state.players[player.playerId] = p;
            }
            updateScore();
        });

        socket.on("playerDisconnected", (playerId) => {
            delete game.state.players[playerId];
        });

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (const player in game.state.players) {
                ctx.fillStyle = "rgba(30, 30, 30, 0.25)";
                ctx.fillRect(game.state.players[player].x, game.state.players[player].y, 32, 32);
                if (player == playerId) {
                    continue;
                }
            }

            for (const fruit in game.state.fruits) {
                ctx.fillStyle = "rgb(200, 70, 45)";
                ctx.fillRect(
                    game.state.fruits[fruit].x,
                    game.state.fruits[fruit].y,
                    32, 32
                )
            }

            if (playerId) {
                let p = game.state.players[playerId];
                ctx.fillStyle = "rgb(40, 200, 40)";
                ctx.fillRect(p.x, p.y, 32, 32);
            }

            requestAnimationFrame(draw);
        }

        draw();
    </script>

</body>

</html>
